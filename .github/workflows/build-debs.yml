name: Build ArrayFire .deb packages

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  build-debs:
    runs-on: ubuntu-latest
    permissions: write-all
    env:
      # Use /mnt for download and build artifacts to save space on root filesystem
      WORK_DIR: /mnt/arrayfire-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup work directory
        run: |
          # Create and use /mnt for building to avoid space issues on root filesystem
          sudo mkdir -p ${{ env.WORK_DIR }}
          sudo chown $USER:$USER ${{ env.WORK_DIR }}
          cd ${{ env.WORK_DIR }}
          pwd
          df -h ${{ env.WORK_DIR }}

      - name: Install packaging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            dpkg-dev debhelper build-essential ca-certificates aria2 unzip xz-utils file

      - name: Download ArrayFire installer
        run: |
          cd ${{ env.WORK_DIR }}
          URL=https://arrayfire.s3.amazonaws.com/3.10.0/ArrayFire-v3.10.0_Linux_x86_64.sh
          aria2c "$URL" -o ArrayFire-installer.sh
          chmod +x ArrayFire-installer.sh
          df -h .

      - name: Extract tar.gz from ArrayFire installer
        run: |
          set -euo pipefail
          cd ${{ env.WORK_DIR }}

          # Find the line number of "Start of TAR.GZ file" using -a flag for binary files
          line_num=$(grep -a -n "Start of TAR.GZ file" ArrayFire-installer.sh | cut -d: -f1)

          if [[ -z "$line_num" ]]; then
            echo "Error: Could not find 'Start of TAR.GZ file' marker" >&2
            exit 1
          fi

          echo "Found 'Start of TAR.GZ file' at line $line_num"

          # Extract tar.gz starting from 2 lines after the marker (skip marker line + 2 more lines)
          start_line=$((line_num + 2))
          echo "Extracting tar.gz data starting from line $start_line"

          # Extract the binary tar.gz data directly to tar and extract immediately
          # This avoids keeping intermediate files around
          tail -n +$start_line ArrayFire-installer.sh | gunzip | tar -x

          # Clean up - delete large installer file immediately
          rm -f ArrayFire-installer.sh

          echo "Extraction completed successfully"
          df -h
          ls -la | head -20

      - name: Copy extracted files to workspace
        run: |
          cd ${{ env.WORK_DIR }}
          # Copy extracted files to workspace for packaging
          cp -r lib64 include share etc ${{ github.workspace }}/
          ls -la ${{ github.workspace }} | head -20

      - name: Verify extraction
        run: |
          if [[ ! -d lib64 && ! -d share/ArrayFire && ! -d include ]]; then
            echo "Extraction failed: expected lib64/include/share/ArrayFire to exist" >&2
            exit 2
          fi

      - name: Clean up cache and temporary files
        run: |
          # Free up disk space before building
          sudo apt-get clean
          sudo apt-get autoclean
          sudo apt-get autoremove -y
          # Clean work directory
          rm -rf ${{ env.WORK_DIR }}/*
          df -h

      - name: Make packaging script executable
        run: chmod +x packaging/make_deb.sh

      - name: Build .deb packages
        run: |
          set -euo pipefail

          # Create build directory in /mnt for faster builds and more space
          mkdir -p ${{ env.WORK_DIR }}/debbuild
          export DEBBUILD_DIR="${{ env.WORK_DIR }}/debbuild"

          cd packaging
          FLAVORS=(cpu cuda opencl oneapi full)
          for f in "${FLAVORS[@]}"; do
            echo "Building flavor: $f"
            DEBBUILD_DIR="${DEBBUILD_DIR}" ./make_deb.sh "$f" || echo "make_deb.sh failed for $f" && true

            # Clean up debbuild directory after each package to save space
            rm -rf "${DEBBUILD_DIR}/arrayfire-${f}_*"
            df -h ${{ env.WORK_DIR }}
          done

          # Copy final .deb files to packaging directory
          cp ${{ env.WORK_DIR }}/debbuild/../*.deb . || true

      - name: Clean up extracted files to save space
        run: |
          # Remove extracted lib64, include, share folders to free up space
          rm -rf lib64 include share etc
          # Clean work directory
          sudo rm -rf ${{ env.WORK_DIR }}
          df -h

      - name: Upload produced .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arrayfire-debs
          path: |
            packaging/*.deb
